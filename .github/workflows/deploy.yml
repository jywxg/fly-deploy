name: Deploy to Fly.io

on:
  workflow_dispatch: # 仅保留手动触发按钮，完全禁止代码推送时的自动部署

# 将所有部署相关的变量从 GitHub Secrets 中安全读取
env:
  APP_NAME: ${{ secrets.APP_NAME }}
  REGION: ${{ secrets.REGION }}
  VOLUME_NAME: ${{ secrets.VOLUME_NAME }}
  VOLUME_SIZE: ${{ secrets.VOLUME_SIZE }}

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} # 全局注入 Fly.io 部署 Token
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create Fly.io App (if not exists)
        # 尝试使用变量创建应用，如果应用已存在则忽略报错继续往下走
        run: flyctl apps create ${{ env.APP_NAME }} --org personal || true

      - name: Create Persistent Volume (if not exists)
        # 尝试使用变量在指定节点创建存储卷，静默确认 (--yes)，如果已存在则忽略报错
        run: flyctl volumes create ${{ env.VOLUME_NAME }} --app ${{ env.APP_NAME }} --region ${{ env.REGION }} --size ${{ env.VOLUME_SIZE }} --yes || true

      - name: Deploy to Fly.io
        # 执行最终的推送和部署
        run: flyctl deploy --remote-only
