name: Deploy to Fly.io

on:
  push:
    branches:
      - main # 当有代码推送到 main 分支时触发自动部署
  workflow_dispatch: # 添加手动触发按钮，方便在网页上随时直接运行

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} # 全局注入 Token，供所有步骤使用
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create Fly.io App (if not exists)
        # 尝试创建应用，如果应用已存在则忽略报错继续往下走
        run: flyctl apps create vaultwarden-webdav --org personal || true

      - name: Create Persistent Volume (if not exists)
        # 尝试在 sin 节点创建 1GB 存储卷，静默确认 (--yes)，如果已存在则忽略报错
        run: flyctl volumes create vw_data --app vaultwarden-webdav --region sin --size 1 --yes || true

      - name: Deploy to Fly.io
        # 执行最终的推送和部署
        run: flyctl deploy --remote-only
